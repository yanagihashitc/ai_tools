# Commit, push & create PR (one-shot)

## Overview

This command is a template for committing changes on the current branch, pushing them to the remote,  
and then creating a Pull Request.  
Branch protection (e.g. disallowing direct pushes to main/master), quality checks (lint / test / build),  
and the PR creation flow (AI/MCP vs CLI) should be customized per project.

## Preconditions

- There are modified files.
- The remote `origin` is configured.
- GitHub CLI (`gh`) is installed (for the CLI fallback).
- You are on a working branch (e.g. `feature/...`, `fix/...`).

## Steps (non-interactive)

1. Check the branch (prevent direct pushes to main/master).
2. Optionally run quality checks (lint / test / build).
3. Stage changes (`git add -A`).
4. Commit (use an environment variable or argument for the message).
5. Push (`git push -u origin <current-branch>`).
6. Create a PR (via MCP or CLI, depending on your environment).

## Usage

### A) Minimal input (recommended)

You only specify the commit message; PR title/body are generated by AI (MCP, etc.).

```bash
# Commit message only (example)
MSG="fix: remove unnecessary debug log output"

# One-shot execution
BRANCH=$(git branch --show-current) && \
if [ "$BRANCH" = "main" ] || [ "$BRANCH" = "master" ]; then \
  echo "⚠️ Direct pushes to main/master are not allowed"; exit 1; \
fi

# Optional quality checks (only if needed)
# Example:
# ./scripts/lint.sh && ./scripts/test.sh && ./scripts/build.sh || exit 1

git add -A && \
git commit -m "$MSG" && \
git push -u origin "$BRANCH"

# At this point, ask AI to create a PR, for example:
# - Infer intent from the branch name
# - Inspect changes via: git diff --name-status
# - Generate PR title and body
# - Create the PR via mcp_github_create_pull_request or `gh pr create`
```

> Note: MCP (Model Context Protocol) is a standard protocol for safely allowing agents to interact with external services like GitHub.  
> To use it for PR creation, you will need an MCP-compatible environment and GitHub integration. See: <https://modelcontextprotocol.io/>

### B) Manually specifying PR title and body

```bash
# Variables
MSG="fix: remove unnecessary debug log output"
PR_TITLE="fix: remove unnecessary debug log output"
PR_BODY=$(cat <<'EOF'
## Overview
This PR removes unnecessary debug log output and reduces log volume.

## Changes
- Remove redundant debug log lines
- Keep only the necessary log levels and messages

## Technical details
- The impact is limited to logging; no business logic changes

## Tests
- Manually confirmed log output and behavior

## Related issues
Refs #123
EOF
)
# Note: <<'EOF' (with quotes) prevents variable expansion in the here-document.
# If you need to include variables in your PR body, use <<EOF (without quotes) instead.

# One-shot execution
BRANCH=$(git branch --show-current) && \
if [ "$BRANCH" = "main" ] || [ "$BRANCH" = "master" ]; then \
  echo "⚠️ Direct pushes to main/master are not allowed"; exit 1; \
fi

# Optional quality checks (only if needed)
# ./scripts/quality-check.sh || exit 1

git add -A && \
git commit -m "$MSG" && \
git push -u origin "$BRANCH" && \
gh pr create --title "$PR_TITLE" --body "$PR_BODY" --base main
```

### C) Step-by-step (for debugging)

```bash
# 1) Check branch
BRANCH=$(git branch --show-current)
echo "Current branch: $BRANCH"
if [ "$BRANCH" = "main" ] || [ "$BRANCH" = "master" ]; then
  echo "⚠️ Direct pushes to main/master are not allowed"; exit 1;
fi

# 2) Check changed files
echo "Changed files:"
git status --short

# 3) Optional local quality checks (add as needed)
# Example:
# echo "Running quality checks..."
# ./scripts/lint.sh && ./scripts/test.sh && ./scripts/build.sh || exit 1

# 4) Stage changes
git add -A
echo "Staging completed"

# 5) Commit
MSG="fix: remove unnecessary debug log output"
git commit -m "$MSG"
echo "Commit completed"

# 6) Push
git push -u origin "$BRANCH"
echo "Push completed"

# 7) Create PR (via AI or CLI)
# After this, use AI or `gh` to create a PR using:
# - Branch name: $BRANCH
# - Diff: git diff main...HEAD --name-status
# - Commit log: git log main..HEAD --oneline
```

## Information sources for PR auto-generation

When AI generates PRs, it typically uses the following information:

```bash
# Current branch (for intent inference)
git branch --show-current

# Merge base with origin/main
git merge-base origin/main HEAD

# Changed files
git diff --name-status $(git merge-base origin/main HEAD)...HEAD

# Change statistics (optional)
git diff --stat $(git merge-base origin/main HEAD)...HEAD

# Commit history
git log origin/main..HEAD --oneline
```

> **Note on branch references:** The commands above use `origin/main` (remote branch) to ensure comparison against the latest remote state. When creating PRs with `gh pr create --base main`, the `main` argument refers to the target branch name on the remote repository. Both approaches are correct in their respective contexts.

## PR title and message rules

- Detailed PR title and body format should follow `.cursor/rules/pr-message-format.mdc`.
- This command assumes you write PR messages using the structured format defined in that rule (e.g. Overview / Changes / Tests).

## Notes

- Commit message formatting and generation principles should follow `.cursor/rules/commit-message-format.mdc`.
- Always review diffs with `git status` and `git diff` before running this command.

## Troubleshooting

### Push succeeded but PR creation failed

```bash
# Create only the PR manually
gh pr create --title "Title" --body "Message" --base main
```

## Prefix inference from branch names

| Branch prefix | Prefix   |
| ------------- | -------- |
| feature/      | feat     |
| fix/          | fix      |
| refactor/     | refactor |
| perf/         | perf     |
| test/         | test     |
| docs/         | docs     |
| build/        | build    |
| ci/           | ci       |
| chore/        | chore    |


